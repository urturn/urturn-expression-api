<h1>Store and Retrieve Data</h1>
<p>This guide describes how to save and retrieve data in an Expression.</p>

<p>Stored data are either in <tt>#storage</tt> or in <tt>#collection</tt>.</p>
<p>The <strong>storage</strong> is used to store post content and is loaded in the editor and the player. The storage can be written only during editing and only by the creator of the post himself or herself. Any amout of reasonably-sized data can be stored in this place.</p>
<p>The <strong>collections</strong> are public spaces where post viewers can store data.</p>


<h2>The Storage API</h2>

<p>
  To use the simple storage API, you need to use the expression.storage object. All the properties of this object will be saved and can be retrieved in other instances of the current post.<br/>
  This API is similar to the W3C localStorage API, with the addition of a save method. You can consider the expression.storage object as persistant across all instances of a post in "view" and "edit" mode.</p>
<pre class="prettyprint"><code class="lang-javscript">
// editor.html
&lt;script>
  UT.Expression.ready( function(post) {
    // Handle edition
    var img = post.storage.grimPicture || null;
    var saying = post.storage.saying || 'YES!';
    var score = post.storage.score || 0;
    var parameters = post.storage.parameters || {layout: 1, color: '#FFFFFF', ratio: 1.0};

    // Set some data
    post.storage.grimPicture = new UT.Image('http://superphoto.jk/photos/121233.jpg');
    post.storage.saying = 'WHOA!';
    post.storage.score = 2.13;
    post.storage.parameters = {ratio: 0.92, layout: 2, color: '#443F22'};

    // Save the data on the server side (the call is synchronous on your side since we provide latency compensation).
    post.save();
  });
&lt;/script>

// player.html
&lt;script>
  UT.Expression.ready( function(post) {
    // Get the data
    var img = post.storage.grimPicture;        // --> Retrieve a UT.Image instance
    var saying = post.storage.saying;          // --> Retrieve a 'WHOA!'
    var score = post.storage.score;            // --> Retrieve 2.13
    var parameters = post.storage.parameters;  // Retrieve {...}
  }
&lt;/script>
</code></pre>

<h2>The Collections API</h2>
<p>The collections API lets you store items of viewers' posts in order to:</p>
<ul>
  <li>Compute <tt>average</tt>, <tt>count</tt> or <tt>sum</tt> on specific fields.</li>
  <li>Retrieve recent items stored by the user.</li>
</ul>
<p>Public collections are writable by any Urturn users. However, there are some important restrictive factors:</p>
<ul>
  <li>No more than one item per user and per collection.</li>
  <li>Only the item of the current user can be modified.</li>
  <li>Only the recent items will be retrieved (although sum, average and count include all items).</li>
</ul>
<h3>Samples</h3>
<p>First, you need to define a collection in expression.json. All authorized fields
must be declared here. All other fields will be silently stripped out on save of the items to those collections.</p>
<pre class="prettyprint"><code class="lang-json">
{
  "title":"This or That",
  "system_name":"this_or_that",
  "version":"1.1.0",
  "collections": [
  {
    "name":"votes", 
    "fields":[
      {
        "name":"thisOne",
        "type":"boolean",
        "operations":["count"]
      },
      {
        "name":"thatOne",
        "type":"boolean",
        "operations":["count"]
      }
    ]
  }
  ]
}
</code></pre>
<pre class="prettyprint"><code class="lang-javascript">
{
  "title":"Trendy",
  "system_name":"trendy",
  "version":"1.1.0",
  "collections": [
  {
    "name":"scores", 
    "fields":[
      {
        "name":"note",
        "type":"number",
        "operations":["average"]
      }
    ]
  }
  ]
}
</code></pre>
<p>Once declared in expression.json, you can retrieve a collection, get and set items and display the result of the announced operation.</p>
<pre class="prettyprint"><code class="lang-javascript"
>UT.Expression.ready( function( post ) {
  var votes = post.collection('votes');
  if(votes.getUserItem()){
    // Display the results directly
  } else {
    // Display the voting interface
  }

  function onVote(thisOrThat){
    var item = {};
    if(thisOrThat == 'this'){
      item.thisOne = true;
    } else {
      item.thatOne = true;
    }
    votes.setUserItem(item);
    // Now save the data
    post.save();
  }

  function results() {
    var total = votes.count();
    var thisOne = votes.count('thisOne');
    var thatOne = votes.count('thatOne');
    return {
      thisScore: thisOne/total * 100,
      thatScore: thatOne/total * 100
    };
  }
});
</code></pre>

<pre class="prettyprint"><code class="lang-javascript"
>UT.Expression.ready( function( post ) {
  var scores = post.collection('scores');
  function results() {
    return scores.average('notes');
  }
});
</code></pre>

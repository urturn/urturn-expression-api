var UT={},WD=UT;UT.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),n="x"==e?t:8|3&t;return n.toString(16)})},UT.UUID=UT.uuid;var supportGetSet=function(){try{!Object.prototype.__defineGetter__&&Object.defineProperty({},"x",{get:function(){return!0}}).x&&(Object.defineProperty(Object.prototype,"__defineGetter__",{enumerable:!1,configurable:!0,value:function(e,t){Object.defineProperty(this,e,{get:t,enumerable:!0,configurable:!0})}}),Object.defineProperty(Object.prototype,"__defineSetter__",{enumerable:!1,configurable:!0,value:function(e,t){Object.defineProperty(this,e,{set:t,enumerable:!0,configurable:!0})}}))}catch(e){throw Error("Simple Storage API not Supported")}};supportGetSet(),function(){"use strict";UT.Collection=function(e){var t,n,r,i,o,s,a,u,l,c,f=this;this.length=0,this.name=null,this.isPublic=function(){return!1};var p=this.setItem=function(e,t){if(!e)throw Error("InvalidKey",e);if(UT.Collection.isReservedKey(e))throw Error("ReservedKey",e);var n=i[e],r=m(e,t);return r||i[e]?(!n||null!==r&&void 0!==r?!n&&r?(l++,s.push(e),i[e]=r):i[e]=r:(s.splice(s.indexOf(e),1),l--,delete i[e]),-1==a.indexOf(e)&&a.push(e),f.length=s.length,o[e]=t,t):r},h=function(e){return-1===u.indexOf(e)&&void 0!==f[e]?f[e]:void 0},d=this.getItem=function(e,t){if(!e)return null;var n=o[e];return n||(n=UT.Collection.buildItem(i[e]),void 0===n&&(n=h(e)),void 0===n&&(n=t),o[e]=n),n};this.key=function(e){return e>=s.length?null:s[e]},this.count=function(){return l},this.toString=function(){return'<Collection @name="'+f.name+'">'},this.save=function(){x();var e={};if(a.length>0){for(var t=0;a.length>t;t++)e[a[t]]=UT.Collection.marshallItem(i[a[t]]);n.save(f.name,e),a=[]}},this.getCurrentData=function(){var e={name:f.name,count:l,definition:r.definition,operations:[],items:[],"public":!1};if(r.operations)for(var t=0;r.operations.length>t;t++){var n={operation:r.operations[t].operation,field:r.operations[t].field};opsToolbox[n.operation].toJsonData(c[n.field],n),e.operations.push(n)}for(var o in i){var s=i[o];s._key=o,e.items.push(s)}return e},this.refresh=function(e){g.call(f,{currentUserId:t,delegate:n,data:e})};var m=UT.Collection.sanitizeItem,g=function(e){UT.Collection.validateOptions(e),c={},s=[],a=[],u=[],t=e.currentUserId,n=e.delegate,r=e.data,f.name=r.name,l=r.count,v(r.items)},v=function(e){if(i={},o={},e){for(var t=0;e.length>t;t++){var n=e[t],r=n._key;i[r]=n,y(r,n),s.push(r)}f.length=s.length}},y=function(e){-1!=u.indexOf(e)||UT.Collection.isReservedKey(e)||(u.push(e),f.__defineGetter__(e,function(){return d.call(f,e)}),f.__defineSetter__(e,function(t){return p.call(f,e,t)}))},x=function(){for(var e=Object.keys(f),t=e.length-1;t>=0;t--){var n=e[t];UT.Collection.isReservedKey(n)||-1!=u.indexOf(n)||(p(n,f[n]),y(n,f[n]))}};g(e)},UT.Collection.RESERVED_KEYS=["refresh","setItem","getItem","count","sum","key","isPublic","getUserItem","setUserItem","average","toString","size","length","name","save","fieldDefs","sanitizedItem","getCurrentData"],UT.Collection.isReservedKey=function(e){return UT.Collection.RESERVED_KEYS.indexOf(e)>=0},UT.Collection.validateOptions=function(e){if(!e.data)throw Error("ArgumentError","missing data");if(!e.data.name)throw Error("ArgumentError","no name in data");if(void 0===e.data.count)throw Error("ArgumentError","no count in data")},UT.Collection.marshallItem=function(e){return e&&e.marshall?e.marshall():void 0!==e&&null!==e?e:null},UT.Collection.sanitizeItem=function(e,t){if("function"==typeof t)throw Error("ArgumentError cannot serialize function");var n=UT.Collection.marshallItem(t);if(null!==n){if(("object"!=typeof n||[].constructor===n.constructor)&&(n={_type:"literal",value:n}),n._key=e,!n||n.constructor!=={}.constructor)throw Error("Unserialisable object");return JSON.parse(JSON.stringify(n))}return null},UT.Collection.buildItem=function(e){return e&&e._type&&UT.Collection.ItemBuilders[e._type]?UT.Collection.ItemBuilders[e._type](e):e},UT.Collection.ItemBuilders={image:function(e){return new UT.Image(e)},sound:function(e){return new UT.Sound(e)},video:function(e){return new UT.Video(e)},literal:function(e){return e.value}}}(),function(){"use strict";var e=["recent","friends"];UT.PublicCollection=function(t){this.length=0,this.name=null;var n=null,r=!1;this.isPublic=function(){return!0},this.setUserItem=function(e){if(!s)throw a.authenticate(),Error("ArgumentError","No currentUserId defined");var t=s,i=o(t,e),u=n;return i||u?(p(u,i),!u||null!==i&&void 0!==i?!u&&i?(c++,n=i):n=i:(c--,n=null),r=!0,n):i};var i=this.getUserItem=function(){return s?n:void 0};this.average=function(e){return l[e]?l[e].average:void 0},this.sum=function(e){return l[e]?l[e].sum:void 0};var o=function(e,t){var n=UT.Collection.sanitizeItem(e,t),r=u.definition.fields;if(t&&r&&r.length>0){for(var i=!1,o=0;r.length>o;o++){var s=r[o];if(void 0!==t[s.name])if(i=!0,"string"==s.type)n[s.name]=t[s.name];else if("number"==s.type){var a=parseFloat(t[s.name]);if(isNaN(a)||!isFinite(t[s.name]))throw Error("TypeError","Wrong value for field note");n[s.name]=a}else{if("boolean"!=s.type)throw Error("TypeError","Unkown type "+s.type);n[s.name]=!!t[s.name]}}if(!i)throw Error("InvalidItemError no valid field specified")}return n};this.count=function(e){if(!e)return c;if(l[e])return l[e]?l[e].count:void 0},this.toString=function(){return'<PublicCollection @name="'+this.name+'">'},this.save=function(){if(r){var e={};e[s]=UT.Collection.marshallItem(n),a.save(this.name,e),r=!1}},this.getCurrentData=function(){var e={name:this.name,count:c,definition:u.definition,operations:[],items:[],"public":!0};if(u.operations)for(var t=0;u.operations.length>t;t++){var r={operation:u.operations[t].operation,field:u.operations[t].field};f[r.operation].toJsonData(l[r.field],r),e.operations.push(r)}i()&&(n._key=s,e.items.push(i()));for(var o=0;u.items.length>o;o++)u.items[o]._key&&u.items[o]._key!=s&&e.items.push(u.items[o]);return e},this.find=function(t,n){if("function"==typeof t&&(n=t,t={filters:{recent:!0}}),"string"==typeof t){if(-1===e.indexOf(t))throw Error("invalid filter ("+t+")");var r={};r[t]=!0,t={filters:r}}if(!n||"function"!=typeof n)throw Error("missing callback argument");a.find(this.name,t,n)},this.refresh=function(e){h.call(this,{currentUserId:s,delegate:a,data:e})};var s,a,u,l,c,f={_transfer:function(e,t){for(var n=Array.prototype.slice.call(arguments,2),r=n.length-1;r>=0;r--)t[n[r]]=e[n[r]]},average:{fromJsonData:function(e,t){void 0===t.average||void 0===t.average_count?(e.average=-1,e.average_count=0):f._transfer(t,e,"average","average_count")},toJsonData:function(e,t){f._transfer(e,t,"average","average_count")},recompute:function(e,t,n,r){var i=e.average_count;n&&void 0!==n[t.field]&&(e.average=1===i?-1:(e.average*i-n[t.field])/parseFloat(i-1),i--),r&&void 0!==r[t.field]&&(e.average=(e.average*i+r[t.field])/parseFloat(i+1),i++),e.average_count=i}},count:{fromJsonData:function(e,t){void 0===t.count?e.count=0:f._transfer(t,e,"count")},toJsonData:function(e,t){f._transfer(e,t,"count")},recompute:function(e,t,n,r){n&&n[t.field]&&void 0!==n[t.field]&&(e.count=e.count-1),r&&r[t.field]&&void 0!==r[t.field]&&e.count++}},sum:{fromJsonData:function(e,t){void 0===t.sum?e.sum=0:f._transfer(t,e,"sum")},toJsonData:function(e,t){f._transfer(e,t,"sum")},recompute:function(e,t,n,r){n&&n[t.field]&&void 0!==n[t.field]&&(e.sum=e.sum-n[t.field]),r&&r[t.field]&&void 0!==r[t.field]&&(e.sum=e.sum+r[t.field])}}},p=function(e,t){if(u.operations)for(var n=0;u.operations.length>n;n++){var r=u.operations[n];(t&&void 0!==t[r.field]||e&&void 0!==e[r.field])&&f[r.operation].recompute(l[r.field],r,e,t)}},h=function(e){if(UT.Collection.validateOptions(e),l={},s=e.currentUserId,a=e.delegate,u=e.data,this.name=u.name,c=u.count,u.operations)for(var t=0;u.operations.length>t;t++){var n=u.operations[t];l[n.field]=l[n.field]||{},f[n.operation].fromJsonData(l[n.field],n)}d.call(this,u.items)},d=function(e){if(e)for(var t=0;e.length>t;t++){var r=e[t],i=r._key;i==s&&(n=r)}};h.call(this,t)}}(),UT.CollectionStore=function(e){this.data=e.data;var t=e.delegate;t.store=this;for(var n={},r=0;this.data.length>r;r++){var i=this.data[r],o=i.name;if(!o)throw Error("ArgumentError","data contains unamed collections.");n[o]=i.public?new UT.PublicCollection({data:i,postMessageApi:e.postMessageApi,currentUserId:e.currentUserId,delegate:t}):new UT.Collection({data:i,postMessageApi:e.postMessageApi,currentUserId:e.currentUserId,delegate:t})}this.get=function(e){return n[e]},this.set=function(e){n[e.name]=e},this.each=function(e){for(var t in n)e(n[t])},this.flush=function(){t.flush()},this.getCurrentData=function(){i=[];for(var e in n)i.push(n[e].getCurrentData());return i},this.refresh=function(e,n){t.refreshCollections(e,n)}};
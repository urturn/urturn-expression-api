var UT={},WD=UT;UT.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),i="x"==e?t:8|3&t;return i.toString(16)})},UT.UUID=UT.uuid;var supportGetSet=function(){try{!Object.prototype.__defineGetter__&&Object.defineProperty({},"x",{get:function(){return!0}}).x&&(Object.defineProperty(Object.prototype,"__defineGetter__",{enumerable:!1,configurable:!0,value:function(e,t){Object.defineProperty(this,e,{get:t,enumerable:!0,configurable:!0})}}),Object.defineProperty(Object.prototype,"__defineSetter__",{enumerable:!1,configurable:!0,value:function(e,t){Object.defineProperty(this,e,{set:t,enumerable:!0,configurable:!0})}}))}catch(e){throw Error("Simple Storage API not Supported")}};supportGetSet(),function(e,t,i,n){"use strict";e.Collection=function(t){var i,o,r,s,a,u,l,c,d,h,p=this;this.length=0,this.name=null,this.isPublic=function(){return!1};var f=this.setItem=function(t,i){if(!t)throw Error("InvalidKey",t);if(e.Collection.isReservedKey(t))throw Error("ReservedKey",t);var o=s[t],r=v(t,i);return r||s[t]?(!o||null!==r&&r!==n?!o&&r?(d++,u.push(t),s[t]=r):s[t]=r:(u.splice(u.indexOf(t),1),d--,delete s[t]),-1==l.indexOf(t)&&l.push(t),p.length=u.length,a[t]=i,i):r},m=function(e){return-1===c.indexOf(e)&&p[e]!==n?p[e]:n},g=this.getItem=function(t,i){if(!t)return null;var o=a[t];return o||(o=e.Collection.buildItem(s[t]),o===n&&(o=m(t)),o===n&&(o=i),a[t]=o),o};this.key=function(e){return e>=u.length?null:u[e]},this.count=function(){return d},this.toString=function(){return'<Collection @name="'+p.name+'">'},this.save=function(){x();var t={};if(l.length>0){for(var i=0;l.length>i;i++)t[l[i]]=e.Collection.marshallItem(s[l[i]]);o.save(p.name,t),l=[]}},this.getCurrentData=function(){var e={name:p.name,count:d,definition:r.definition,operations:[],items:[],"public":!1};if(r.operations)for(var t=0;r.operations.length>t;t++){var i={operation:r.operations[t].operation,field:r.operations[t].field};opsToolbox[i.operation].toJsonData(h[i.field],i),e.operations.push(i)}for(var n in s){var o=s[n];o._key=n,e.items.push(o)}return e},this.refresh=function(e){y.call(p,{currentUserId:i,delegate:o,data:e})};var v=e.Collection.sanitizeItem,y=function(t){e.Collection.validateOptions(t),h={},u=[],l=[],c=[],i=t.currentUserId,o=t.delegate,r=t.data,p.name=r.name,d=r.count,b(r.items)},b=function(e){if(s={},a={},e){for(var t=0;e.length>t;t++){var i=e[t],n=i._key;s[n]=i,w(n,i),u.push(n)}p.length=u.length}},w=function(t){-1!=c.indexOf(t)||e.Collection.isReservedKey(t)||(c.push(t),p.__defineGetter__(t,function(){return g.call(p,t)}),p.__defineSetter__(t,function(e){return f.call(p,t,e)}))},x=function(){for(var t=Object.keys(p),i=t.length-1;i>=0;i--){var n=t[i];e.Collection.isReservedKey(n)||-1!=c.indexOf(n)||(f(n,p[n]),w(n,p[n]))}};y(t)},e.Collection.RESERVED_KEYS=["refresh","setItem","getItem","count","sum","key","isPublic","getUserItem","setUserItem","average","toString","size","length","name","save","fieldDefs","sanitizedItem","getCurrentData"],e.Collection.isReservedKey=function(t){return e.Collection.RESERVED_KEYS.indexOf(t)>=0},e.Collection.validateOptions=function(e){if(!e.data)throw Error("ArgumentError","missing data");if(!e.data.name)throw Error("ArgumentError","no name in data");if(e.data.count===n)throw Error("ArgumentError","no count in data")},e.Collection.marshallItem=function(e){return e&&e.marshall?e.marshall():e!==n&&null!==e?e:null},e.Collection.sanitizeItem=function(t,i){if("function"==typeof i)throw Error("ArgumentError cannot serialize function");var n=e.Collection.marshallItem(i);if(null!==n){if(("object"!=typeof n||[].constructor===n.constructor)&&(n={_type:"literal",value:n}),n._key=t,!n||n.constructor!=={}.constructor)throw Error("Unserialisable object");return JSON.parse(JSON.stringify(n))}return null},e.Collection.buildItem=function(t){return t&&t._type&&e.Collection.ItemBuilders[t._type]?e.Collection.ItemBuilders[t._type](t):t},e.Collection.ItemBuilders={image:function(t){return new e.Image(t)},sound:function(t){return new e.Sound(t)},video:function(t){return new e.Video(t)},literal:function(e){return e.value}}}(UT,window,document,void 0),function(e,t,i,n){"use strict";var o=["recent","friends"];e.PublicCollection=function(t){this.length=0,this.name=null;var i=null,r=!1;this.isPublic=function(){return!0},this.setUserItem=function(e){if(!u)throw l.authenticate(),Error("ArgumentError","No currentUserId defined");var t=u,o=a(t,e),s=i;return o||s?(f(s,o),!s||null!==o&&o!==n?!s&&o?(h++,i=o):i=o:(h--,i=null),r=!0,i):o};var s=this.getUserItem=function(){return u?i:n};this.average=function(e){return d[e]?d[e].average:n},this.sum=function(e){return d[e]?d[e].sum:n};var a=function(t,i){var o=e.Collection.sanitizeItem(t,i),r=c.definition.fields;if(i&&r&&r.length>0){for(var s=!1,a=0;r.length>a;a++){var u=r[a];if(i[u.name]!==n)if(s=!0,"string"==u.type)o[u.name]=i[u.name];else if("number"==u.type){var l=parseFloat(i[u.name]);if(isNaN(l)||!isFinite(i[u.name]))throw Error("TypeError","Wrong value for field note");o[u.name]=l}else{if("boolean"!=u.type)throw Error("TypeError","Unknown type "+u.type);o[u.name]=!!i[u.name]}}if(!s)throw Error("InvalidItemError no valid field specified")}return o};this.count=function(e){if(!e)return h;if(d[e])return d[e]?d[e].count:n},this.toString=function(){return'<PublicCollection @name="'+this.name+'">'},this.save=function(){if(r){var t={};t[u]=e.Collection.marshallItem(i),l.save(this.name,t),r=!1}},this.getCurrentData=function(){var e={name:this.name,count:h,definition:c.definition,operations:[],items:[],"public":!0};if(c.operations)for(var t=0;c.operations.length>t;t++){var n={operation:c.operations[t].operation,field:c.operations[t].field};p[n.operation].toJsonData(d[n.field],n),e.operations.push(n)}s()&&(i._key=u,e.items.push(s()));for(var o=0;c.items.length>o;o++)c.items[o]._key&&c.items[o]._key!=u&&e.items.push(c.items[o]);return e},this.find=function(e,t){if("function"==typeof e&&(t=e,e={filters:{recent:!0}}),"string"==typeof e){if(-1===o.indexOf(e))throw Error("invalid filter ("+e+")");var i={};i[e]=!0,e={filters:i}}if(!t||"function"!=typeof t)throw Error("missing callback argument");l.find(this.name,e,t)},this.refresh=function(e){m.call(this,{currentUserId:u,delegate:l,data:e})};var u,l,c,d,h,p={_transfer:function(e,t){for(var i=Array.prototype.slice.call(arguments,2),n=i.length-1;n>=0;n--)t[i[n]]=e[i[n]]},average:{fromJsonData:function(e,t){t.average===n||t.average_count===n?(e.average=-1,e.average_count=0):p._transfer(t,e,"average","average_count")},toJsonData:function(e,t){p._transfer(e,t,"average","average_count")},recompute:function(e,t,i,o){var r=e.average_count;i&&i[t.field]!==n&&(e.average=1===r?-1:(e.average*r-i[t.field])/parseFloat(r-1),r--),o&&o[t.field]!==n&&(e.average=(e.average*r+o[t.field])/parseFloat(r+1),r++),e.average_count=r}},count:{fromJsonData:function(e,t){t.count===n?e.count=0:p._transfer(t,e,"count")},toJsonData:function(e,t){p._transfer(e,t,"count")},recompute:function(e,t,i,o){i&&i[t.field]&&i[t.field]!==n&&(e.count=e.count-1),o&&o[t.field]&&o[t.field]!==n&&e.count++}},sum:{fromJsonData:function(e,t){t.sum===n?e.sum=0:p._transfer(t,e,"sum")},toJsonData:function(e,t){p._transfer(e,t,"sum")},recompute:function(e,t,i,o){i&&i[t.field]&&i[t.field]!==n&&(e.sum=e.sum-i[t.field]),o&&o[t.field]&&o[t.field]!==n&&(e.sum=e.sum+o[t.field])}}},f=function(e,t){if(c.operations)for(var i=0;c.operations.length>i;i++){var o=c.operations[i];(t&&t[o.field]!==n||e&&e[o.field]!==n)&&p[o.operation].recompute(d[o.field],o,e,t)}},m=function(t){if(e.Collection.validateOptions(t),d={},u=t.currentUserId,l=t.delegate,c=t.data,this.name=c.name,h=c.count,c.operations)for(var i=0;c.operations.length>i;i++){var n=c.operations[i];d[n.field]=d[n.field]||{},p[n.operation].fromJsonData(d[n.field],n)}g.call(this,c.items)},g=function(e){if(e)for(var t=0;e.length>t;t++){var n=e[t],o=n._key;o==u&&(i=n)}};m.call(this,t)}}(UT,window,document,void 0),UT.CollectionStore=function(e){this.data=e.data;var t=e.delegate;t.store=this;for(var i={},n=0;this.data.length>n;n++){var o=this.data[n],r=o.name;if(!r)throw Error("ArgumentError","data contains unamed collections.");i[r]=o.public?new UT.PublicCollection({data:o,postMessageApi:e.postMessageApi,currentUserId:e.currentUserId,delegate:t}):new UT.Collection({data:o,postMessageApi:e.postMessageApi,currentUserId:e.currentUserId,delegate:t})}this.get=function(e){return i[e]},this.set=function(e){i[e.name]=e},this.each=function(e){for(var t in i)e(i[t])},this.flush=function(){t.flush()},this.getCurrentData=function(){o=[];for(var e in i)o.push(i[e].getCurrentData());return o},this.refresh=function(e,i){t.refreshCollections(e,i)}};
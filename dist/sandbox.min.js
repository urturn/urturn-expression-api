var UT={},WD=UT;UT.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=0|16*Math.random(),n="x"==t?e:8|3&e;return n.toString(16)})},UT.UUID=UT.uuid;var supportGetSet=function(){try{!Object.prototype.__defineGetter__&&Object.defineProperty({},"x",{get:function(){return!0}}).x&&(Object.defineProperty(Object.prototype,"__defineGetter__",{enumerable:!1,configurable:!0,value:function(t,e){Object.defineProperty(this,t,{get:e,enumerable:!0,configurable:!0})}}),Object.defineProperty(Object.prototype,"__defineSetter__",{enumerable:!1,configurable:!0,value:function(t,e){Object.defineProperty(this,t,{set:e,enumerable:!0,configurable:!0})}}))}catch(t){throw Error("Simple Storage API not Supported")}};supportGetSet(),function(){"use strict";UT.Collection=function(t){var e,n,i,r,o,a,s,c,l,u,f=this;this.length=0,this.name=null,this.isPublic=function(){return!1};var d=this.setItem=function(t,e){if(!t)throw Error("InvalidKey",t);if(UT.Collection.isReservedKey(t))throw Error("ReservedKey",t);var n=r[t],i=v(t,e);return i||r[t]?(!n||null!==i&&void 0!==i?!n&&i?(l++,a.push(t),r[t]=i):r[t]=i:(a.splice(a.indexOf(t),1),l--,delete r[t]),-1==s.indexOf(t)&&s.push(t),f.length=a.length,o[t]=e,e):i},h=function(t){return-1===c.indexOf(t)&&void 0!==f[t]?f[t]:void 0},p=this.getItem=function(t,e){if(!t)return null;var n=o[t];return n||(n=UT.Collection.buildItem(r[t]),void 0===n&&(n=h(t)),void 0===n&&(n=e),o[t]=n),n};this.key=function(t){return t>=a.length?null:a[t]},this.count=function(){return l},this.toString=function(){return'<Collection @name="'+f.name+'">'},this.save=function(){T();var t={};if(s.length>0){for(var e=0;s.length>e;e++)t[s[e]]=UT.Collection.marshallItem(r[s[e]]);n.save(f.name,t),s=[]}},this.getCurrentData=function(){var t={name:f.name,count:l,definition:i.definition,operations:[],items:[],"public":!1};if(i.operations)for(var e=0;i.operations.length>e;e++){var n={operation:i.operations[e].operation,field:i.operations[e].field};opsToolbox[n.operation].toJsonData(u[n.field],n),t.operations.push(n)}for(var o in r){var a=r[o];a._key=o,t.items.push(a)}return t},this.refresh=function(t){m.call(f,{currentUserId:e,delegate:n,data:t})};var v=UT.Collection.sanitizeItem,m=function(t){UT.Collection.validateOptions(t),u={},a=[],s=[],c=[],e=t.currentUserId,n=t.delegate,i=t.data,f.name=i.name,l=i.count,g(i.items)},g=function(t){if(r={},o={},t){for(var e=0;t.length>e;e++){var n=t[e],i=n._key;r[i]=n,y(i,n),a.push(i)}f.length=a.length}},y=function(t){-1!=c.indexOf(t)||UT.Collection.isReservedKey(t)||(c.push(t),f.__defineGetter__(t,function(){return p.call(f,t)}),f.__defineSetter__(t,function(e){return d.call(f,t,e)}))},T=function(){for(var t=Object.keys(f),e=t.length-1;e>=0;e--){var n=t[e];UT.Collection.isReservedKey(n)||-1!=c.indexOf(n)||(d(n,f[n]),y(n,f[n]))}};m(t)},UT.Collection.RESERVED_KEYS=["refresh","setItem","getItem","count","sum","key","isPublic","getUserItem","setUserItem","average","toString","size","length","name","save","fieldDefs","sanitizedItem","getCurrentData"],UT.Collection.isReservedKey=function(t){return UT.Collection.RESERVED_KEYS.indexOf(t)>=0},UT.Collection.validateOptions=function(t){if(!t.data)throw Error("ArgumentError","missing data");if(!t.data.name)throw Error("ArgumentError","no name in data");if(void 0===t.data.count)throw Error("ArgumentError","no count in data")},UT.Collection.marshallItem=function(t){return t&&t.marshall?t.marshall():void 0!==t&&null!==t?t:null},UT.Collection.sanitizeItem=function(t,e){if("function"==typeof e)throw Error("ArgumentError cannot serialize function");var n=UT.Collection.marshallItem(e);if(null!==n){if(("object"!=typeof n||[].constructor===n.constructor)&&(n={_type:"literal",value:n}),n._key=t,!n||n.constructor!=={}.constructor)throw Error("Unserialisable object");return JSON.parse(JSON.stringify(n))}return null},UT.Collection.buildItem=function(t){return t&&t._type&&UT.Collection.ItemBuilders[t._type]?UT.Collection.ItemBuilders[t._type](t):t},UT.Collection.ItemBuilders={image:function(t){return new UT.Image(t)},sound:function(t){return new UT.Sound(t)},video:function(t){return new UT.Video(t)},literal:function(t){return t.value}}}(),function(){"use strict";var t=["recent","friends"];UT.PublicCollection=function(e){this.length=0,this.name=null;var n=null,i=!1;this.isPublic=function(){return!0},this.setUserItem=function(t){if(!a)throw s.authenticate(),Error("ArgumentError","No currentUserId defined");var e=a,r=o(e,t),c=n;return r||c?(d(c,r),!c||null!==r&&void 0!==r?!c&&r?(u++,n=r):n=r:(u--,n=null),i=!0,n):r};var r=this.getUserItem=function(){return a?n:void 0};this.average=function(t){return l[t]?l[t].average:void 0},this.sum=function(t){return l[t]?l[t].sum:void 0};var o=function(t,e){var n=UT.Collection.sanitizeItem(t,e),i=c.definition.fields;if(e&&i&&i.length>0){for(var r=!1,o=0;i.length>o;o++){var a=i[o];if(void 0!==e[a.name])if(r=!0,"string"==a.type)n[a.name]=e[a.name];else if("number"==a.type){var s=parseFloat(e[a.name]);if(isNaN(s)||!isFinite(e[a.name]))throw Error("TypeError","Wrong value for field note");n[a.name]=s}else{if("boolean"!=a.type)throw Error("TypeError","Unkown type "+a.type);n[a.name]=!!e[a.name]}}if(!r)throw Error("InvalidItemError no valid field specified")}return n};this.count=function(t){if(!t)return u;if(l[t])return l[t]?l[t].count:void 0},this.toString=function(){return'<PublicCollection @name="'+this.name+'">'},this.save=function(){if(i){var t={};t[a]=UT.Collection.marshallItem(n),s.save(this.name,t),i=!1}},this.getCurrentData=function(){var t={name:this.name,count:u,definition:c.definition,operations:[],items:[],"public":!0};if(c.operations)for(var e=0;c.operations.length>e;e++){var i={operation:c.operations[e].operation,field:c.operations[e].field};f[i.operation].toJsonData(l[i.field],i),t.operations.push(i)}r()&&(n._key=a,t.items.push(r()));for(var o=0;c.items.length>o;o++)c.items[o]._key&&c.items[o]._key!=a&&t.items.push(c.items[o]);return t},this.find=function(e,n){if("function"==typeof e&&(n=e,e={filters:{recent:!0}}),"string"==typeof e){if(-1===t.indexOf(e))throw Error("invalid filter ("+e+")");var i={};i[e]=!0,e={filters:i}}if(!n||"function"!=typeof n)throw Error("missing callback argument");s.find(this.name,e,n)},this.refresh=function(t){h.call(this,{currentUserId:a,delegate:s,data:t})};var a,s,c,l,u,f={_transfer:function(t,e){for(var n=Array.prototype.slice.call(arguments,2),i=n.length-1;i>=0;i--)e[n[i]]=t[n[i]]},average:{fromJsonData:function(t,e){void 0===e.average||void 0===e.average_count?(t.average=-1,t.average_count=0):f._transfer(e,t,"average","average_count")},toJsonData:function(t,e){f._transfer(t,e,"average","average_count")},recompute:function(t,e,n,i){var r=t.average_count;n&&void 0!==n[e.field]&&(t.average=1===r?-1:(t.average*r-n[e.field])/parseFloat(r-1),r--),i&&void 0!==i[e.field]&&(t.average=(t.average*r+i[e.field])/parseFloat(r+1),r++),t.average_count=r}},count:{fromJsonData:function(t,e){void 0===e.count?t.count=0:f._transfer(e,t,"count")},toJsonData:function(t,e){f._transfer(t,e,"count")},recompute:function(t,e,n,i){n&&n[e.field]&&void 0!==n[e.field]&&(t.count=t.count-1),i&&i[e.field]&&void 0!==i[e.field]&&t.count++}},sum:{fromJsonData:function(t,e){void 0===e.sum?t.sum=0:f._transfer(e,t,"sum")},toJsonData:function(t,e){f._transfer(t,e,"sum")},recompute:function(t,e,n,i){n&&n[e.field]&&void 0!==n[e.field]&&(t.sum=t.sum-n[e.field]),i&&i[e.field]&&void 0!==i[e.field]&&(t.sum=t.sum+i[e.field])}}},d=function(t,e){if(c.operations)for(var n=0;c.operations.length>n;n++){var i=c.operations[n];(e&&void 0!==e[i.field]||t&&void 0!==t[i.field])&&f[i.operation].recompute(l[i.field],i,t,e)}},h=function(t){if(UT.Collection.validateOptions(t),l={},a=t.currentUserId,s=t.delegate,c=t.data,this.name=c.name,u=c.count,c.operations)for(var e=0;c.operations.length>e;e++){var n=c.operations[e];l[n.field]=l[n.field]||{},f[n.operation].fromJsonData(l[n.field],n)}p.call(this,c.items)},p=function(t){if(t)for(var e=0;t.length>e;e++){var i=t[e],r=i._key;r==a&&(n=i)}};h.call(this,e)}}(),UT.CollectionStore=function(t){this.data=t.data;var e=t.delegate;e.store=this;for(var n={},i=0;this.data.length>i;i++){var r=this.data[i],o=r.name;if(!o)throw Error("ArgumentError","data contains unamed collections.");n[o]=r.public?new UT.PublicCollection({data:r,postMessageApi:t.postMessageApi,currentUserId:t.currentUserId,delegate:e}):new UT.Collection({data:r,postMessageApi:t.postMessageApi,currentUserId:t.currentUserId,delegate:e})}this.get=function(t){return n[t]},this.set=function(t){n[t.name]=t},this.each=function(t){for(var e in n)t(n[e])},this.flush=function(){e.flush()},this.getCurrentData=function(){r=[];for(var t in n)r.push(n[t].getCurrentData());return r},this.refresh=function(t,n){e.refreshCollections(t,n)}};
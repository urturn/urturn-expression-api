var UT={},WD=UT;UT.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),n="x"==e?t:8|3&t;return n.toString(16)})},UT.UUID=UT.uuid;var supportGetSet=function(){try{!Object.prototype.__defineGetter__&&Object.defineProperty({},"x",{get:function(){return!0}}).x&&(Object.defineProperty(Object.prototype,"__defineGetter__",{enumerable:!1,configurable:!0,value:function(e,t){Object.defineProperty(this,e,{get:t,enumerable:!0,configurable:!0})}}),Object.defineProperty(Object.prototype,"__defineSetter__",{enumerable:!1,configurable:!0,value:function(e,t){Object.defineProperty(this,e,{set:t,enumerable:!0,configurable:!0})}}))}catch(e){throw Error("Simple Storage API not Supported")}};supportGetSet(),function(e,t,n,i){"use strict";e.Collection=function(t){var n,r,s,o,a,l,u,c,h,d,p=this;this.length=0,this.name=null,this.isPublic=function(){return!1};var f=this.setItem=function(t,n){if(!t)throw Error("InvalidKey",t);if(e.Collection.isReservedKey(t))throw Error("ReservedKey",t);var r=o[t],s=v(t,n);return s||o[t]?(!r||null!==s&&s!==i?!r&&s?(h++,l.push(t),o[t]=s):o[t]=s:(l.splice(l.indexOf(t),1),h--,delete o[t]),-1==u.indexOf(t)&&u.push(t),p.length=l.length,a[t]=n,n):s},m=function(e){return-1===c.indexOf(e)&&p[e]!==i?p[e]:i},g=this.getItem=function(t,n){if(!t)return null;var r=a[t];return r||(r=e.Collection.buildItem(o[t]),r===i&&(r=m(t)),r===i&&(r=n),a[t]=r),r};this.key=function(e){return e>=l.length?null:l[e]},this.count=function(){return h},this.toString=function(){return'<Collection @name="'+p.name+'">'},this.save=function(){_();var t={};if(u.length>0){for(var n=0;u.length>n;n++)t[u[n]]=e.Collection.marshallItem(o[u[n]]);r.save(p.name,t),u=[]}},this.getCurrentData=function(){var e={name:p.name,count:h,definition:s.definition,operations:[],items:[],"public":!1};if(s.operations)for(var t=0;s.operations.length>t;t++){var n={operation:s.operations[t].operation,field:s.operations[t].field};opsToolbox[n.operation].toJsonData(d[n.field],n),e.operations.push(n)}for(var i in o){var r=o[i];r._key=i,e.items.push(r)}return e},this.refresh=function(e){y.call(p,{currentUserId:n,delegate:r,data:e})};var v=e.Collection.sanitizeItem,y=function(t){e.Collection.validateOptions(t),d={},l=[],u=[],c=[],n=t.currentUserId,r=t.delegate,s=t.data,p.name=s.name,h=s.count,b(s.items)},b=function(e){if(o={},a={},e){for(var t=0;e.length>t;t++){var n=e[t],i=n._key;o[i]=n,w(i,n),l.push(i)}p.length=l.length}},w=function(t){-1!=c.indexOf(t)||e.Collection.isReservedKey(t)||(c.push(t),p.__defineGetter__(t,function(){return g.call(p,t)}),p.__defineSetter__(t,function(e){return f.call(p,t,e)}))},_=function(){for(var t=Object.keys(p),n=t.length-1;n>=0;n--){var i=t[n];e.Collection.isReservedKey(i)||-1!=c.indexOf(i)||(f(i,p[i]),w(i,p[i]))}};y(t)},e.Collection.RESERVED_KEYS=["refresh","setItem","getItem","count","sum","key","isPublic","getUserItem","setUserItem","average","toString","size","length","name","save","fieldDefs","sanitizedItem","getCurrentData"],e.Collection.isReservedKey=function(t){return e.Collection.RESERVED_KEYS.indexOf(t)>=0},e.Collection.validateOptions=function(e){if(!e.data)throw Error("ArgumentError","missing data");if(!e.data.name)throw Error("ArgumentError","no name in data");if(e.data.count===i)throw Error("ArgumentError","no count in data")},e.Collection.marshallItem=function(e){return e&&e.marshall?e.marshall():e!==i&&null!==e?e:null},e.Collection.sanitizeItem=function(t,n){if("function"==typeof n)throw Error("ArgumentError cannot serialize function");var i=e.Collection.marshallItem(n);if(null!==i){if(("object"!=typeof i||[].constructor===i.constructor)&&(i={_type:"literal",value:i}),i._key=t,!i||i.constructor!=={}.constructor)throw Error("Unserialisable object");return JSON.parse(JSON.stringify(i))}return null},e.Collection.buildItem=function(t){return t&&t._type&&e.Collection.ItemBuilders[t._type]?e.Collection.ItemBuilders[t._type](t):t},e.Collection.ItemBuilders={image:function(t){return new e.Image(t)},sound:function(t){return new e.Sound(t)},video:function(t){return new e.Video(t)},literal:function(e){return e.value}}}(UT,window,document,void 0),function(e,t,n,i){"use strict";var r=["recent","friends"];e.PublicCollection=function(t){this.length=0,this.name=null;var n=null,s=!1;this.isPublic=function(){return!0},this.setUserItem=function(e){if(!l)throw u.authenticate(),Error("ArgumentError","No currentUserId defined");var t=l,r=a(t,e),o=n;return r||o?(f(o,r),!o||null!==r&&r!==i?!o&&r?(d++,n=r):n=r:(d--,n=null),s=!0,n):r};var o=this.getUserItem=function(){return l?n:i};this.average=function(e){return h[e]?h[e].average:i},this.sum=function(e){return h[e]?h[e].sum:i};var a=function(t,n){var r=e.Collection.sanitizeItem(t,n),s=c.definition.fields;if(n&&s&&s.length>0){for(var o=!1,a=0;s.length>a;a++){var l=s[a];if(n[l.name]!==i)if(o=!0,"string"==l.type)r[l.name]=n[l.name];else if("number"==l.type){var u=parseFloat(n[l.name]);if(isNaN(u)||!isFinite(n[l.name]))throw Error("TypeError","Wrong value for field note");r[l.name]=u}else{if("boolean"!=l.type)throw Error("TypeError","Unkown type "+l.type);r[l.name]=!!n[l.name]}}if(!o)throw Error("InvalidItemError no valid field specified")}return r};this.count=function(e){if(!e)return d;if(h[e])return h[e]?h[e].count:i},this.toString=function(){return'<PublicCollection @name="'+this.name+'">'},this.save=function(){if(s){var t={};t[l]=e.Collection.marshallItem(n),u.save(this.name,t),s=!1}},this.getCurrentData=function(){var e={name:this.name,count:d,definition:c.definition,operations:[],items:[],"public":!0};if(c.operations)for(var t=0;c.operations.length>t;t++){var i={operation:c.operations[t].operation,field:c.operations[t].field};p[i.operation].toJsonData(h[i.field],i),e.operations.push(i)}o()&&(n._key=l,e.items.push(o()));for(var r=0;c.items.length>r;r++)c.items[r]._key&&c.items[r]._key!=l&&e.items.push(c.items[r]);return e},this.find=function(e,t){if("function"==typeof e&&(t=e,e={filters:{recent:!0}}),"string"==typeof e){if(-1===r.indexOf(e))throw Error("invalid filter ("+e+")");var n={};n[e]=!0,e={filters:n}}if(!t||"function"!=typeof t)throw Error("missing callback argument");u.find(this.name,e,t)},this.refresh=function(e){m.call(this,{currentUserId:l,delegate:u,data:e})};var l,u,c,h,d,p={_transfer:function(e,t){for(var n=Array.prototype.slice.call(arguments,2),i=n.length-1;i>=0;i--)t[n[i]]=e[n[i]]},average:{fromJsonData:function(e,t){t.average===i||t.average_count===i?(e.average=-1,e.average_count=0):p._transfer(t,e,"average","average_count")},toJsonData:function(e,t){p._transfer(e,t,"average","average_count")},recompute:function(e,t,n,r){var s=e.average_count;n&&n[t.field]!==i&&(e.average=1===s?-1:(e.average*s-n[t.field])/parseFloat(s-1),s--),r&&r[t.field]!==i&&(e.average=(e.average*s+r[t.field])/parseFloat(s+1),s++),e.average_count=s}},count:{fromJsonData:function(e,t){t.count===i?e.count=0:p._transfer(t,e,"count")},toJsonData:function(e,t){p._transfer(e,t,"count")},recompute:function(e,t,n,r){n&&n[t.field]&&n[t.field]!==i&&(e.count=e.count-1),r&&r[t.field]&&r[t.field]!==i&&e.count++}},sum:{fromJsonData:function(e,t){t.sum===i?e.sum=0:p._transfer(t,e,"sum")},toJsonData:function(e,t){p._transfer(e,t,"sum")},recompute:function(e,t,n,r){n&&n[t.field]&&n[t.field]!==i&&(e.sum=e.sum-n[t.field]),r&&r[t.field]&&r[t.field]!==i&&(e.sum=e.sum+r[t.field])}}},f=function(e,t){if(c.operations)for(var n=0;c.operations.length>n;n++){var r=c.operations[n];(t&&t[r.field]!==i||e&&e[r.field]!==i)&&p[r.operation].recompute(h[r.field],r,e,t)}},m=function(t){if(e.Collection.validateOptions(t),h={},l=t.currentUserId,u=t.delegate,c=t.data,this.name=c.name,d=c.count,c.operations)for(var n=0;c.operations.length>n;n++){var i=c.operations[n];h[i.field]=h[i.field]||{},p[i.operation].fromJsonData(h[i.field],i)}g.call(this,c.items)},g=function(e){if(e)for(var t=0;e.length>t;t++){var i=e[t],r=i._key;r==l&&(n=i)}};m.call(this,t)}}(UT,window,document,void 0),UT.CollectionStore=function(e){this.data=e.data;var t=e.delegate;t.store=this;for(var n={},i=0;this.data.length>i;i++){var r=this.data[i],s=r.name;if(!s)throw Error("ArgumentError","data contains unamed collections.");n[s]=r.public?new UT.PublicCollection({data:r,postMessageApi:e.postMessageApi,currentUserId:e.currentUserId,delegate:t}):new UT.Collection({data:r,postMessageApi:e.postMessageApi,currentUserId:e.currentUserId,delegate:t})}this.get=function(e){return n[e]},this.set=function(e){n[e.name]=e},this.each=function(e){for(var t in n)e(n[t])},this.flush=function(){t.flush()},this.getCurrentData=function(){r=[];for(var e in n)r.push(n[e].getCurrentData());return r},this.refresh=function(e,n){t.refreshCollections(e,n)}};
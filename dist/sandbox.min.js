var UT={},WD=UT;UT.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=0|16*Math.random(),n="x"==t?e:8|3&e;return n.toString(16)})},UT.UUID=UT.uuid;var supportGetSet=function(){try{!Object.prototype.__defineGetter__&&Object.defineProperty({},"x",{get:function(){return!0}}).x&&(Object.defineProperty(Object.prototype,"__defineGetter__",{enumerable:!1,configurable:!0,value:function(t,e){Object.defineProperty(this,t,{get:e,enumerable:!0,configurable:!0})}}),Object.defineProperty(Object.prototype,"__defineSetter__",{enumerable:!1,configurable:!0,value:function(t,e){Object.defineProperty(this,t,{set:e,enumerable:!0,configurable:!0})}}))}catch(t){throw Error("Simple Storage API not Supported")}};supportGetSet(),function(t,e,n,i){"use strict";t.Collection=function(e){var n,o,s,a,r,u,l,c,d,p,h=this;this.length=0,this.name=null,this.isPublic=function(){return!1};var f=this.setItem=function(e,n){if(!e)throw Error("InvalidKey",e);if(t.Collection.isReservedKey(e))throw Error("ReservedKey",e);var o=a[e],s=v(e,n);return s||a[e]?(!o||null!==s&&s!==i?!o&&s?(d++,u.push(e),a[e]=s):a[e]=s:(u.splice(u.indexOf(e),1),d--,delete a[e]),-1==l.indexOf(e)&&l.push(e),h.length=u.length,r[e]=n,n):s},m=function(t){return-1===c.indexOf(t)&&h[t]!==i?h[t]:i},g=this.getItem=function(e,n){if(!e)return null;var o=r[e];return o||(o=t.Collection.buildItem(a[e]),o===i&&(o=m(e)),o===i&&(o=n),r[e]=o),o};this.key=function(t){return t>=u.length?null:u[t]},this.count=function(){return d},this.toString=function(){return'<Collection @name="'+h.name+'">'},this.save=function(){x();var e={};if(l.length>0){for(var n=0;l.length>n;n++)e[l[n]]=t.Collection.marshallItem(a[l[n]]);o.save(h.name,e),l=[]}},this.getCurrentData=function(){var t={name:h.name,count:d,definition:s.definition,operations:[],items:[],"public":!1};if(s.operations)for(var e=0;s.operations.length>e;e++){var n={operation:s.operations[e].operation,field:s.operations[e].field};opsToolbox[n.operation].toJsonData(p[n.field],n),t.operations.push(n)}for(var i in a){var o=a[i];o._key=i,t.items.push(o)}return t},this.refresh=function(t){y.call(h,{currentUserId:n,delegate:o,data:t})};var v=t.Collection.sanitizeItem,y=function(e){t.Collection.validateOptions(e),p={},u=[],l=[],c=[],n=e.currentUserId,o=e.delegate,s=e.data,h.name=s.name,d=s.count,b(s.items)},b=function(t){if(a={},r={},t){for(var e=0;t.length>e;e++){var n=t[e],i=n._key;a[i]=n,w(i,n),u.push(i)}h.length=u.length}},w=function(e){-1!=c.indexOf(e)||t.Collection.isReservedKey(e)||(c.push(e),h.__defineGetter__(e,function(){return g.call(h,e)}),h.__defineSetter__(e,function(t){return f.call(h,e,t)}))},x=function(){for(var e=Object.keys(h),n=e.length-1;n>=0;n--){var i=e[n];t.Collection.isReservedKey(i)||-1!=c.indexOf(i)||(f(i,h[i]),w(i,h[i]))}};y(e)},t.Collection.RESERVED_KEYS=["refresh","setItem","getItem","count","sum","key","isPublic","getUserItem","setUserItem","average","toString","size","length","name","save","fieldDefs","sanitizedItem","getCurrentData"],t.Collection.isReservedKey=function(e){return t.Collection.RESERVED_KEYS.indexOf(e)>=0},t.Collection.validateOptions=function(t){if(!t.data)throw Error("ArgumentError","missing data");if(!t.data.name)throw Error("ArgumentError","no name in data");if(t.data.count===i)throw Error("ArgumentError","no count in data")},t.Collection.marshallItem=function(t){return t&&t.marshall?t.marshall():t!==i&&null!==t?t:null},t.Collection.sanitizeItem=function(e,n){if("function"==typeof n)throw Error("ArgumentError cannot serialize function");var i=t.Collection.marshallItem(n);if(null!==i){if(("object"!=typeof i||[].constructor===i.constructor)&&(i={_type:"literal",value:i}),i._key=e,!i||i.constructor!=={}.constructor)throw Error("Unserialisable object");return JSON.parse(JSON.stringify(i))}return null},t.Collection.buildItem=function(e){return e&&e._type&&t.Collection.ItemBuilders[e._type]?t.Collection.ItemBuilders[e._type](e):e},t.Collection.ItemBuilders={image:function(e){return new t.Image(e)},sound:function(e){return new t.Sound(e)},video:function(e){return new t.Video(e)},literal:function(t){return t.value}}}(UT,window,document,void 0),function(t,e,n,i){"use strict";var o=["recent","friends"];t.PublicCollection=function(e){this.length=0,this.name=null;var n=null,s=!1;this.isPublic=function(){return!0},this.setUserItem=function(t){if(!u)throw l.authenticate(),Error("ArgumentError","No currentUserId defined");var e=u,o=r(e,t),a=n;return o||a?(f(a,o),!a||null!==o&&o!==i?!a&&o?(p++,n=o):n=o:(p--,n=null),s=!0,n):o};var a=this.getUserItem=function(){return u?n:i};this.average=function(t){return d[t]?d[t].average:i},this.sum=function(t){return d[t]?d[t].sum:i};var r=function(e,n){var o=t.Collection.sanitizeItem(e,n),s=c.definition.fields;if(n&&s&&s.length>0){for(var a=!1,r=0;s.length>r;r++){var u=s[r];if(n[u.name]!==i)if(a=!0,"string"==u.type)o[u.name]=n[u.name];else if("number"==u.type){var l=parseFloat(n[u.name]);if(isNaN(l)||!isFinite(n[u.name]))throw Error("TypeError","Wrong value for field note");o[u.name]=l}else{if("boolean"!=u.type)throw Error("TypeError","Unknown type "+u.type);o[u.name]=!!n[u.name]}}if(!a)throw Error("InvalidItemError no valid field specified")}return o};this.count=function(t){if(!t)return p;if(d[t])return d[t]?d[t].count:i},this.toString=function(){return'<PublicCollection @name="'+this.name+'">'},this.save=function(){if(s){var e={};e[u]=t.Collection.marshallItem(n),l.save(this.name,e),s=!1}},this.getCurrentData=function(){var t={name:this.name,count:p,definition:c.definition,operations:[],items:[],"public":!0};if(c.operations)for(var e=0;c.operations.length>e;e++){var i={operation:c.operations[e].operation,field:c.operations[e].field};h[i.operation].toJsonData(d[i.field],i),t.operations.push(i)}a()&&(n._key=u,t.items.push(a()));for(var o=0;c.items.length>o;o++)c.items[o]._key&&c.items[o]._key!=u&&t.items.push(c.items[o]);return t},this.find=function(t,e){if("function"==typeof t&&(e=t,t={filters:{recent:!0}}),"string"==typeof t){if(-1===o.indexOf(t))throw Error("invalid filter ("+t+")");var n={};n[t]=!0,t={filters:n}}if(!e||"function"!=typeof e)throw Error("missing callback argument");l.find(this.name,t,e)},this.refresh=function(t){m.call(this,{currentUserId:u,delegate:l,data:t})};var u,l,c,d,p,h={_transfer:function(t,e){for(var n=Array.prototype.slice.call(arguments,2),i=n.length-1;i>=0;i--)e[n[i]]=t[n[i]]},average:{fromJsonData:function(t,e){e.average===i||e.average_count===i?(t.average=-1,t.average_count=0):h._transfer(e,t,"average","average_count")},toJsonData:function(t,e){h._transfer(t,e,"average","average_count")},recompute:function(t,e,n,o){var s=t.average_count;n&&n[e.field]!==i&&(t.average=1===s?-1:(t.average*s-n[e.field])/parseFloat(s-1),s--),o&&o[e.field]!==i&&(t.average=(t.average*s+o[e.field])/parseFloat(s+1),s++),t.average_count=s}},count:{fromJsonData:function(t,e){e.count===i?t.count=0:h._transfer(e,t,"count")},toJsonData:function(t,e){h._transfer(t,e,"count")},recompute:function(t,e,n,o){n&&n[e.field]&&n[e.field]!==i&&(t.count=t.count-1),o&&o[e.field]&&o[e.field]!==i&&t.count++}},sum:{fromJsonData:function(t,e){e.sum===i?t.sum=0:h._transfer(e,t,"sum")},toJsonData:function(t,e){h._transfer(t,e,"sum")},recompute:function(t,e,n,o){n&&n[e.field]&&n[e.field]!==i&&(t.sum=t.sum-n[e.field]),o&&o[e.field]&&o[e.field]!==i&&(t.sum=t.sum+o[e.field])}}},f=function(t,e){if(c.operations)for(var n=0;c.operations.length>n;n++){var o=c.operations[n];(e&&e[o.field]!==i||t&&t[o.field]!==i)&&h[o.operation].recompute(d[o.field],o,t,e)}},m=function(e){if(t.Collection.validateOptions(e),d={},u=e.currentUserId,l=e.delegate,c=e.data,this.name=c.name,p=c.count,c.operations)for(var n=0;c.operations.length>n;n++){var i=c.operations[n];d[i.field]=d[i.field]||{},h[i.operation].fromJsonData(d[i.field],i)}g.call(this,c.items)},g=function(t){if(t)for(var e=0;t.length>e;e++){var i=t[e],o=i._key;o==u&&(n=i)}};m.call(this,e)}}(UT,window,document,void 0),UT.CollectionStore=function(t){this.data=t.data;var e=t.delegate;e.store=this;for(var n={},i=0;this.data.length>i;i++){var o=this.data[i],s=o.name;if(!s)throw Error("ArgumentError","data contains unamed collections.");n[s]=o.public?new UT.PublicCollection({data:o,postMessageApi:t.postMessageApi,currentUserId:t.currentUserId,delegate:e}):new UT.Collection({data:o,postMessageApi:t.postMessageApi,currentUserId:t.currentUserId,delegate:e})}this.get=function(t){return n[t]},this.set=function(t){n[t.name]=t},this.each=function(t){for(var e in n)t(n[e])},this.flush=function(){e.flush()},this.getCurrentData=function(){o=[];for(var t in n)o.push(n[t].getCurrentData());return o},this.refresh=function(t,n){e.refreshCollections(t,n)}};